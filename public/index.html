<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PWA Emergencias</title>

  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">

  <!-- Icons -->
  <link rel="icon" href="/icons/icon-192.png" type="image/png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <meta name="theme-color" content="#b30000">

  <style>
    /* Small custom styles */
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f3f4f6; }
    .incident-card { transition: transform .18s, box-shadow .18s; }
    .incident-card:hover{ transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,.08); }
    #mapid { height: 360px; border-radius: 0.5rem; overflow: hidden; }
    .modal-hidden { display: none; }
    .btn-disabled { opacity: .5; pointer-events: none; }
  </style>
</head>

<body class="min-h-screen antialiased">

  <!-- HEADER -->
  <header class="bg-red-700 fixed w-full top-0 z-30 shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <h1 class="text-white text-2xl font-bold">üö® PWA EMERGENCIAS</h1>
        <span id="label-role" class="text-red-100 text-sm ml-2"></span>
      </div>

      <div class="flex items-center gap-3">
        <button id="btn-update-incidents" class="px-3 py-2 bg-white text-red-700 rounded-full shadow hover:bg-red-50">Actualizar</button>
        <button id="btn-activate-push" class="px-3 py-2 bg-blue-600 text-white rounded-md disabled:opacity-60" disabled>Activar Notificaciones</button>
        <button id="btn-send-test" class="px-3 py-2 bg-green-600 text-white rounded-md disabled:opacity-60" disabled>Enviar Prueba</button>
        <button id="btn-logout" class="px-3 py-2 bg-red-600 text-white rounded-md hidden">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 pt-24 pb-12">

    <!-- STATUS & VAPID -->
    <section class="mb-6 p-4 bg-white rounded-lg shadow">
      <div class="flex items-center justify-between">
        <div>
          <div id="vapid-key-display" class="text-sm text-gray-600">Clave VAPID: <span class="font-mono text-xs text-gray-800">Cargando...</span></div>
          <div id="pwa-status" class="text-xs text-yellow-700 mt-1">Service Worker: comprobando...</div>
        </div>
        <div class="text-right text-sm text-gray-500">Estado: <span id="connection-label">‚Äî</span></div>
      </div>
    </section>

    <!-- CONTENT -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- INCIDENTS LIST -->
      <div class="lg:col-span-2">
        <div class="bg-white p-4 rounded-lg shadow">
          <h2 class="text-xl font-semibold mb-3">Incidentes recientes</h2>
          <div id="incidents-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div id="loading-message" class="col-span-full text-center text-gray-500 p-8">Cargando datos...</div>
          </div>
        </div>

        <!-- MAP -->
        <div class="mt-6 bg-white p-4 rounded-lg shadow">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">Mapa de emergencias</h3>
            <div class="flex gap-2">
              <button id="btn-center-me" class="px-2 py-1 bg-indigo-600 text-white rounded text-sm">Mi ubicaci√≥n</button>
              <button id="btn-report-emergency" class="px-2 py-1 bg-red-600 text-white rounded text-sm">Reportar mi ubicaci√≥n</button>
            </div>
          </div>
          <div id="mapid"></div>
        </div>
      </div>

      <!-- SIDE PANEL -->
      <aside>
        <div class="bg-white p-4 rounded-lg shadow">
          <h3 class="font-semibold mb-2">Controles</h3>
          <p class="text-sm text-gray-500 mb-3">Usa estos controles para probar la app.</p>
          <button id="btn-refresh" class="w-full mb-2 px-3 py-2 bg-gray-800 text-white rounded">Refrescar incidentes</button>
          <button id="btn-open-login" class="w-full mb-2 px-3 py-2 bg-yellow-600 text-white rounded">Abrir Login</button>
          <div class="mt-4 text-xs text-gray-400">
            <p>Para push: activa notificaciones y luego prueba enviar.</p>
          </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mt-4">
          <h4 class="font-semibold">Informaci√≥n</h4>
          <p class="text-sm text-gray-600 mt-2">La app funciona offline usando el Service Worker y IndexedDB. Las notificaciones usan Web Push / VAPID.</p>
        </div>
      </aside>
    </section>

  </main>

  <!-- MODAL: mensajes -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
    <div class="bg-white rounded-lg max-w-md w-full p-4">
      <h3 id="modal-title" class="text-lg font-bold text-red-700 mb-2">T√≠tulo</h3>
      <p id="modal-body" class="text-gray-700 mb-4">Contenido</p>
      <div class="flex justify-end gap-2">
        <button id="modal-close" class="px-3 py-2 bg-gray-200 rounded">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-sm w-full p-6">
      <h3 class="text-xl font-semibold mb-3">Iniciar sesi√≥n</h3>
      <input id="loginEmail" type="email" placeholder="Correo" class="w-full mb-2 p-2 border rounded" />
      <input id="loginPassword" type="password" placeholder="Contrase√±a" class="w-full mb-4 p-2 border rounded" />
      <div class="flex gap-2">
        <button id="loginSubmit" class="flex-1 px-3 py-2 bg-red-600 text-white rounded">Entrar</button>
        <button id="loginCancel" class="flex-1 px-3 py-2 bg-gray-200 rounded">Cancelar</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Usuarios demo: policia@... / bombero@... / medico@... (contrase√±a: 123456)</p>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- MAIN SCRIPT (integrado) -->
  <script>
  /**********************
   * SHORT HELPERS
   **********************/
  const $ = id => document.getElementById(id);
  const showModal = (title, body) => {
    if (!$('modal')) return alert(title + '\n\n' + body);
    $('modal-title').textContent = title;
    $('modal-body').textContent = body;
    $('modal').classList.remove('hidden'); $('modal').classList.add('flex');
  };
  if ($('modal-close')) $('modal-close').addEventListener('click', () => {
    $('modal').classList.add('hidden'); $('modal').classList.remove('flex');
  });

  /**********************
   * AUTH (Login + Session)
   **********************/
  const loginModal = $('loginModal');
  const loginSubmit = $('loginSubmit');
  const loginCancel = $('loginCancel');
  const btnOpenLogin = $('btn-open-login');
  const btnLogout = $('btn-logout');
  const labelRole = $('label-role');

  if (btnOpenLogin) btnOpenLogin.addEventListener('click', () => {
    if (!loginModal) return;
    loginModal.classList.remove('hidden'); loginModal.classList.add('flex');
  });
  if (loginCancel) loginCancel.addEventListener('click', () => {
    if (!loginModal) return;
    loginModal.classList.add('hidden'); loginModal.classList.remove('flex');
  });

  async function tryServerLogin(email, password) {
    try {
      const resp = await fetch('/api/login', {
        method: 'POST', headers: {'content-type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      if (!resp.ok) return null;
      const data = await resp.json();
      return data && data.ok && data.user ? data.user : null;
    } catch (e) {
      console.warn('Login server failed', e);
      return null;
    }
  }

  if (loginSubmit) loginSubmit.addEventListener('click', async () => {
    const email = $('loginEmail')?.value?.trim() || '';
    const password = $('loginPassword')?.value?.trim() || '';
    if (!email || !password) { showModal('Error', 'Completa correo y contrase√±a'); return; }

    // 1) Try server
    const serverUser = await tryServerLogin(email, password);
    if (serverUser) {
      localStorage.setItem('pwaUser', JSON.stringify(serverUser));
      if (loginModal) { loginModal.classList.add('hidden'); loginModal.classList.remove('flex'); }
      applyUser(serverUser);
      return;
    }

    // 2) fallback demo users
    const demoUsers = [
      { email: 'policia@emergencias.com', password: '123456', role: 'policia' },
      { email: 'bombero@emergencias.com', password: '123456', role: 'bombero' },
      { email: 'medico@emergencias.com', password: '123456', role: 'medico' }
    ];
    const found = demoUsers.find(u => u.email === email && u.password === password);
    if (!found) { showModal('Error', 'Credenciales incorrectas'); return; }
    const user = { email: found.email, role: found.role };
    localStorage.setItem('pwaUser', JSON.stringify(user));
    if (loginModal) { loginModal.classList.add('hidden'); loginModal.classList.remove('flex'); }
    applyUser(user);
  });

  function applyUser(user) {
    if (!user) return;
    if (btnLogout) btnLogout.classList.remove('hidden');
    if ($('pwa-status')) $('pwa-status').textContent = `Usuario: ${user.email} (rol: ${user.role})`;
    if (labelRole) labelRole.textContent = `(${user.role})`;
  }

  // auto-apply if already logged
  const savedUser = localStorage.getItem('pwaUser');
  if (savedUser) applyUser(JSON.parse(savedUser));

  if (btnLogout) btnLogout.addEventListener('click', () => {
    localStorage.removeItem('pwaUser');
    if (btnLogout) btnLogout.classList.add('hidden');
    if (labelRole) labelRole.textContent = '';
    showModal('Sesi√≥n cerrada', 'Has cerrado sesi√≥n correctamente');
  });

  /**********************
   * INCIDENTS (load + render)
   **********************/
  const incidentsContainer = $('incidents-container');

  function renderIncidentCard(i) {
    const isAcc = (i.title || i.titulo || '').toString().toLowerCase().includes('accident') || (i.title || i.titulo || '').toString().toLowerCase().includes('accidente');
    const title = i.title || i.titulo || 'Incidente';
    const description = i.description || i.descripcion || '';
    return `
      <div class="incident-card bg-white p-4 rounded shadow">
        <div class="flex items-start gap-3">
          <div class="text-2xl">${isAcc ? 'üöë' : '‚ö†Ô∏è'}</div>
          <div>
            <h4 class="font-semibold">${title}</h4>
            <p class="text-sm text-gray-600 mt-1">${description}</p>
            <div class="text-xs text-gray-400 mt-2">ID: ${i.id || i.idincidente || '‚Äî'}</div>
          </div>
        </div>
      </div>
    `;
  }

  async function loadIncidents() {
    if (!incidentsContainer) return;
    incidentsContainer.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">Cargando incidentes...</div>';
    try {
      let resp = await fetch('/api/incidents');
      if (!resp.ok) resp = await fetch('/api/emergencias');
      const data = await resp.json();
      incidentsContainer.innerHTML = '';
      if (!data || data.length === 0) {
        incidentsContainer.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">No hay incidentes.</div>';
        if ($('connection-label')) $('connection-label').textContent = 'Online';
        return;
      }
      data.forEach(i => incidentsContainer.innerHTML += renderIncidentCard(i));
      if ($('connection-label')) $('connection-label').textContent = 'Online';
    } catch (e) {
      console.warn('No se pudo cargar incidents:', e);
      incidentsContainer.innerHTML = '<div class="col-span-full text-center p-8 text-yellow-700 bg-yellow-100 rounded">Est√°s offline. Muestra datos guardados si los hay.</div>';
      if ($('connection-label')) $('connection-label').textContent = 'Offline';
    }
  }

  if ($('btn-update-incidents')) $('btn-update-incidents').addEventListener('click', () => { loadIncidents(); loadEmergenciesOnMap(); });
  if ($('btn-refresh')) $('btn-refresh').addEventListener('click', () => { loadIncidents(); loadEmergenciesOnMap(); });

  /**********************
   * MAP (Leaflet)
   **********************/
  let map, userMarker, emergencyMarkers = [];

  function initMap() {
    try {
      if (!('L' in window)) return console.warn('Leaflet no cargado');
      map = L.map('mapid', { preferCanvas: true }).setView([19.4326, -99.1332], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '¬© OpenStreetMap'
      }).addTo(map);
      loadEmergenciesOnMap();
    } catch (err) {
      console.warn('initMap err', err);
    }
  }

  async function loadEmergenciesOnMap() {
    if (!map) return;
    try {
      let resp = await fetch('/api/emergencias');
      if (!resp.ok) resp = await fetch('/api/incidents');
      const data = await resp.json();

      // clear previous markers
      emergencyMarkers.forEach(m => { try { map.removeLayer(m); } catch(e){} });
      emergencyMarkers = [];

      const bounds = [];
      data.forEach(e => {
        const lat = parseFloat(e.lat || e.latitude || e.latitud);
        const lng = parseFloat(e.lng || e.longitude || e.longitud);
        if (isNaN(lat) || isNaN(lng)) return;
        const marker = L.marker([lat, lng]).addTo(map).bindPopup(`<strong>${e.title || e.titulo || 'Incidente'}</strong><br>${e.description || e.descripcion || ''}`);
        emergencyMarkers.push(marker);
        bounds.push([lat, lng]);
      });

      if (bounds.length) {
        try {
          const b = L.latLngBounds(bounds);
          map.fitBounds(b.pad(0.2));
        } catch (e) { /* ignore */ }
      }
    } catch (err) {
      console.warn('No se pudieron cargar emergencias para el mapa', err);
    }
  }

  async function centerOnUser() {
    if (!navigator.geolocation) { showModal('GPS', 'Geolocalizaci√≥n no soportada'); return; }
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      if (map) map.setView([lat, lng], 15);
      if (userMarker && map) try { map.removeLayer(userMarker); } catch(e){}
      if (map) userMarker = L.marker([lat, lng]).addTo(map).bindPopup('Tu ubicaci√≥n').openPopup();
    }, err => showModal('GPS', 'No se pudo obtener la ubicaci√≥n: ' + (err.message||err.code)));
  }

  if ($('btn-center-me')) $('btn-center-me').addEventListener('click', centerOnUser);

  // report user's location as a new emergency
  if ($('btn-report-emergency')) $('btn-report-emergency').addEventListener('click', async () => {
    if (!navigator.geolocation) { showModal('GPS', 'Geolocalizaci√≥n no soportada'); return; }
    navigator.geolocation.getCurrentPosition(async pos => {
      const payload = {
        titulo: 'Emergencia reportada (usuario)',
        descripcion: 'Ubicaci√≥n enviada por operador',
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        timestamp: Date.now()
      };
      try {
        // prefer endpoint /api/reportar else /api/report
        await fetch('/api/reportar', { method: 'POST', headers: {'content-type':'application/json'}, body: JSON.stringify(payload) });
      } catch (e) {
        console.warn('No se pudo enviar reportar:', e);
        // fallback: store locally? notified to user
        showModal('Atenci√≥n', 'No se pudo reportar al servidor. Intenta de nuevo cuando haya conexi√≥n.');
      }
      await loadIncidents();
      await loadEmergenciesOnMap();
      showModal('Enviado', 'Tu ubicaci√≥n fue reportada como emergencia (local).');
    }, err => showModal('GPS', 'No se pudo obtener la ubicaci√≥n'));
  });

  /**********************
   * SERVICE WORKER + PUSH (client-side)
   **********************/
  async function registerServiceWorker() {
    if (!('serviceWorker' in navigator)) { if($('pwa-status')) $('pwa-status').textContent = 'Service Worker no soportado'; return null; }
    try {
      const reg = await navigator.serviceWorker.register('/service-worker.js');
      if ($('pwa-status')) $('pwa-status').textContent = 'Service Worker: Registrado';
      // enable push button once ready
      await navigator.serviceWorker.ready;
      if ($('btn-activate-push')) $('btn-activate-push').disabled = false;
      return reg;
    } catch (err) {
      console.error('Error registrando SW:', err);
      if ($('pwa-status')) $('pwa-status').textContent = 'Error registrando SW';
      return null;
    }
  }

  async function getVapid() {
    try {
      const r = await fetch('/vapidPublicKey');
      if (!r.ok) throw new Error('No VAPID');
      const key = await r.text();
      if ($('vapid-key-display')) $('vapid-key-display').querySelector('span').textContent = key.substring(0,40) + '...';
      return key;
    } catch (e) {
      console.warn('No se obtuvo VAPID:', e);
      if ($('vapid-key-display')) $('vapid-key-display').textContent = 'Clave VAPID p√∫blica: no disponible';
      return null;
    }
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = window.atob(base64);
    return Uint8Array.from([...rawData].map(ch => ch.charCodeAt(0)));
  }

  async function activatePush() {
    const btn = $('btn-activate-push');
    if (btn) { btn.disabled = true; btn.textContent = 'Suscribiendo...'; }
    try {
      const reg = await navigator.serviceWorker.ready;
      const vapidKey = await getVapid();
      if (!vapidKey) { showModal('Error', 'Clave VAPID no disponible'); if(btn){btn.disabled = false; btn.textContent = 'Activar Notificaciones'}; return; }

      const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(vapidKey) });
      // send to server -> according to your server: /save-subscription
      await fetch('/save-subscription', { method: 'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(sub) });

      showModal('Suscripci√≥n', 'Notificaciones activadas correctamente.');
      if ($('btn-send-test')) $('btn-send-test').disabled = false;
      if (btn) btn.textContent = 'Suscrito';
    } catch (err) {
      console.error('activatePush error', err);
      showModal('Error', 'No fue posible suscribir a push: ' + (err.message||err));
      if (btn){ btn.disabled = false; btn.textContent = 'Activar Notificaciones'; }
    }
  }

  async function sendTestNotification() {
    const btn = $('btn-send-test');
    if (btn){ btn.disabled = true; btn.textContent = 'Enviando...'; }
    try {
      const resp = await fetch('/send-notification', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ title:'Prueba', body:'Notificaci√≥n de prueba desde PWA' })});
      const j = await resp.json();
      if (j.ok || resp.ok) showModal('Enviado', 'Notificaci√≥n de prueba enviada.');
      else showModal('Error', 'Fallo al enviar: ' + JSON.stringify(j));
    } catch (e) {
      console.error('sendTestNotification', e);
      showModal('Error', 'No se pudo contactar al servidor para enviar la prueba.');
    }
    if (btn){ btn.disabled = false; btn.textContent = 'Enviar Prueba'; }
  }

  if ($('btn-activate-push')) $('btn-activate-push').addEventListener('click', activatePush);
  if ($('btn-send-test')) $('btn-send-test').addEventListener('click', sendTestNotification);

  /**********************
   * BOOTSTRAP
   **********************/
  window.addEventListener('load', async () => {
    // register SW
    await registerServiceWorker();

    // init map
    initMap();

    // load incidents & map markers
    await loadIncidents();
    await loadEmergenciesOnMap();

    // open login if not logged
    const u = localStorage.getItem('pwaUser');
    if (!u && loginModal) {
      setTimeout(()=>{ loginModal.classList.remove('hidden'); loginModal.classList.add('flex'); }, 400);
    } else if (u) {
      applyUser(JSON.parse(u));
    }
  });

  // ESC to close modals
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if ($('modal')) { $('modal').classList.add('hidden'); $('modal').classList.remove('flex'); }
      if (loginModal) { loginModal.classList.add('hidden'); loginModal.classList.remove('flex'); }
    }
  });
  </script>
</body>
</html>
